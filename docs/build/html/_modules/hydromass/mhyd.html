

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>hydromass.mhyd &mdash; hydromass 0.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> hydromass
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hydromass.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">hydromass</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>hydromass.mhyd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for hydromass.mhyd</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.deproject</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.emissivity</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.plots</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.forward</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.polytropic</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.pnt</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.nonparametric</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">from</span> <span class="nn">.save</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>

<div class="viewcode-block" id="Run_Mhyd_PyMC3"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Run_Mhyd_PyMC3">[docs]</a><span class="k">def</span> <span class="nf">Run_Mhyd_PyMC3</span><span class="p">(</span><span class="n">Mhyd</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">p0_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dmonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mstar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">find_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">pnt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Set up hydrostatic mass model and optimize with PyMC3. The routine takes a parametric mass model as input and integrates the hydrostatic equilibrium equation to predict the 3D pressure profile:</span>

<span class="sd">    .. math::</span>

<span class="sd">        P_{3D}(r) = P_0 + \\int_{r}^{r_0} \\rho_{gas}(r) \\frac{G M_{mod}(&lt;r)}{r^2} dr</span>

<span class="sd">    with :math:`r_0` the outer radial boundary of the input data and :math:`P_0` the pressure at :math:`r_0`.</span>

<span class="sd">    The gas density profile is fitted to the surface brightness profile and described as a linear combination of King functions. The mass model should be defined using the :class:`hydromass.functions.Model` class, which implements a number of popular mass models. The 3D mass profile is then projected along the line of sight an weighted by spectroscopic-like weights to predict the spectroscopic temperature profile.</span>

<span class="sd">    The parameters of the mass model and of the gas density profile are fitted jointly to the data. Priors on the input parameters can be set by the user in the definition of the mass model.</span>

<span class="sd">    :param Mhyd: A :class:`hydromass.mhyd.Mhyd` object including the loaded data and initial setup (mandatory input)</span>
<span class="sd">    :type Mhyd: class:`hydromass.mhyd.Mhyd`</span>
<span class="sd">    :param model:  A :class:`hydromass.functions.Model` object including the chosen mass model and its input values (mandatory input)</span>
<span class="sd">    :type model: class:`hydromass.functions.Model`</span>
<span class="sd">    :param bkglim: Limit (in arcmin) out to which the SB data will be fitted; if None then the whole range is considered. Defaults to None.</span>
<span class="sd">    :type bkglim: float</span>
<span class="sd">    :param nmcmc: Number of PyMC3 steps. Defaults to 1000</span>
<span class="sd">    :type nmcmc: int</span>
<span class="sd">    :param fit_bkg: Choose whether the counts and the background will be fitted on-the-fly using a Poisson model (fit_bkg=True) or if the surface brightness will be fitted, in which case it is assumed that the background has already been subtracted and Gaussian likelihood will be used (default = False)</span>
<span class="sd">    :type fit_bkg: bool</span>
<span class="sd">    :param back: Input value for the background. If None then the mean surface brightness in the region outside &quot;bkglim&quot; is used. Relevant only if fit_bkg = True. Defaults to None.</span>
<span class="sd">    :type back: float</span>
<span class="sd">    :param samplefile: Name of ASCII file to output the final PyMC3 samples</span>
<span class="sd">    :type samplefile: str</span>
<span class="sd">    :param nrc: Number of core radii values to set up the multiscale model. Defaults to the number of data points / 4</span>
<span class="sd">    :type nrc: int</span>
<span class="sd">    :param nbetas: Number of beta values to set up the multiscale model (default = 6)</span>
<span class="sd">    :type nbetas: int</span>
<span class="sd">    :param min_beta: Minimum beta value (default = 0.6)</span>
<span class="sd">    :type min_beta: float</span>
<span class="sd">    :param nmore: Number of points to the define the fine grid onto which the mass model and the integration are performed, i.e. for one spectroscopic/SZ value, how many grid points will be defined. Defaults to 5.</span>
<span class="sd">    :type nmore: int</span>
<span class="sd">    :param p0_prior: Set of two values defining the mean and standard deviation of the Gaussian prior on p0. If None, the code attempts to determine the value of P0 using the :func:`hydromass.plots.estimate_P0` function, which fits a rough gNFW function to estimate the shape of the pressure profile and uses the fitted function to approximate the value of P0.</span>
<span class="sd">    :type p0_prior: numpy.ndarray</span>
<span class="sd">    :param tune: Number of NUTS tuning steps. Defaults to 500</span>
<span class="sd">    :type tune: int</span>
<span class="sd">    :param dmonly: Specify whether the mass model is fitted to the total mass (dmonly=False) or to the dark matter only after subtracting the gas mass and the stellar mass if provided (dmonly=True). Defaults to False.</span>
<span class="sd">    :type dmonly: bool</span>
<span class="sd">    :param mstar: If dmonly=True, provide an array containing the cumulative stellar mass profile, which will be subtracted when adjusting the mass model to the dark matter only.</span>
<span class="sd">    :type mstar: numpy.ndarray</span>
<span class="sd">    :param find_map: Specify whether a maximum likelihood fit will be performed first to initiate the sampler. Defaults to True</span>
<span class="sd">    :type find_map: bool</span>
<span class="sd">    :param pnt: Attempt to model the non-thermal pressure profile. If pnt=True, the non-thermal pressure profile of Angelinelli et al. 2020 and the corresponding parameters are used to marginalize over the impact of non-thermal pressure. Defaults to False.</span>
<span class="sd">    :type pnt: bool</span>
<span class="sd">    :param rmin: Minimum limiting radius (in arcmin) of the active region for the surface brightness. If rmin=None, no minimum radius is applied. Defaults to None.</span>
<span class="sd">    :type rmin: float</span>
<span class="sd">    :param rmax: Maximum limiting radius (in arcmin) of the active region for the surface brightness. If rmax=None, no maximum radius is applied. Defaults to None.</span>
<span class="sd">    :type rmax: float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prof</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">sbprof</span>
    <span class="n">sb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">esb</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">eprof</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bins</span>
    <span class="n">erad</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">ebins</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">counts</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">area</span>
    <span class="n">exposure</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">effexp</span>
    <span class="n">bkgcounts</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">bkgcounts</span>

    <span class="k">if</span> <span class="n">rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span><span class="o">&gt;=</span><span class="n">rmin</span><span class="p">)</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">esb</span> <span class="o">=</span> <span class="n">esb</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">erad</span> <span class="o">=</span> <span class="n">erad</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="n">exposure</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">bkgcounts</span> <span class="o">=</span> <span class="n">bkgcounts</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;=</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="n">sb</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">esb</span> <span class="o">=</span> <span class="n">esb</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">rad</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">erad</span> <span class="o">=</span> <span class="n">erad</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="n">exposure</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">bkgcounts</span> <span class="o">=</span> <span class="n">bkgcounts</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>


    <span class="c1"># Define maximum radius for source deprojection, assuming we have only background for r&gt;bkglim</span>
    <span class="k">if</span> <span class="n">bkglim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bkglim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rad</span><span class="o">+</span><span class="n">erad</span><span class="p">)</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">sb</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">bkglim</span> <span class="o">=</span> <span class="n">bkglim</span>
        <span class="n">backreg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span><span class="o">&gt;</span><span class="n">bkglim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">back</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="n">backreg</span><span class="p">])</span>

    <span class="c1"># Set source region</span>
    <span class="n">sourcereg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rad</span> <span class="o">&lt;</span> <span class="n">bkglim</span><span class="p">)</span>

    <span class="c1"># Set vector with list of parameters</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">list_params</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">nrc</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">,</span> <span class="n">min_beta</span><span class="p">)</span>

    <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psfmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">nbin</span><span class="p">)</span>

    <span class="c1"># Compute linear combination kernel</span>
    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">calc_linear_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">psfmat</span><span class="p">))</span> <span class="c1"># transformation to counts</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">withbkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">,</span> <span class="n">Ksb</span><span class="p">)</span>
        <span class="c1"># K = calc_sb_operator_psf(rad, sourcereg, pars, area, exposure, psfmat) # transformation to surface brightness</span>

    <span class="c1"># Set up initial values</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">npt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">back</span><span class="p">)</span> <span class="ow">or</span> <span class="n">back</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testbkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">redshift</span>

    <span class="n">transf</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.</span> <span class="o">*</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">1e-14</span> <span class="o">*</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">nhc</span> <span class="o">/</span> <span class="n">cgsMpc</span> <span class="o">*</span> <span class="mf">1e3</span>

    <span class="n">pardens</span> <span class="o">=</span> <span class="n">list_params_density</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">nrc</span><span class="p">,</span> <span class="n">nbetas</span><span class="p">,</span> <span class="n">min_beta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

        <span class="n">Kdens</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">Kdens</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">withbkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Define the fine grid onto which the mass model will be computed</span>
    <span class="n">rin_m</span><span class="p">,</span> <span class="n">rout_m</span><span class="p">,</span> <span class="n">index_x</span><span class="p">,</span> <span class="n">index_sz</span><span class="p">,</span> <span class="n">sum_mat</span><span class="p">,</span> <span class="n">ntm</span> <span class="o">=</span> <span class="n">rads_more</span><span class="p">(</span><span class="n">Mhyd</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">)</span>

    <span class="n">rref_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">rin_m</span> <span class="o">+</span> <span class="n">rout_m</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

    <span class="k">if</span> <span class="n">dmonly</span> <span class="ow">and</span> <span class="n">mstar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">r_mstar</span> <span class="o">=</span> <span class="n">mstar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">cum_mstar</span> <span class="o">=</span> <span class="n">mstar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">mstar_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rout_m</span><span class="p">,</span> <span class="n">r_mstar</span><span class="p">,</span> <span class="n">cum_mstar</span><span class="p">)</span>

    <span class="n">nptmore</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rout_m</span><span class="p">)</span>

    <span class="n">int_mat</span> <span class="o">=</span> <span class="n">cumsum_mat</span><span class="p">(</span><span class="n">nptmore</span><span class="p">)</span>

    <span class="n">vx</span> <span class="o">=</span> <span class="n">MyDeprojVol</span><span class="p">(</span><span class="n">rin_m</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">rout_m</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">)</span>

    <span class="n">vol</span> <span class="o">=</span> <span class="n">vx</span><span class="o">.</span><span class="n">deproj_vol</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">cf_prof</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Single conversion factor provided, we will assume it is constant throughout the radial range&#39;</span><span class="p">)</span>

        <span class="n">cf</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rad</span><span class="p">):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The provided conversion factor has a different length as the input radial binning. Adopting the mean value.&#39;</span><span class="p">)</span>

            <span class="n">cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interpolating conversion factor profile onto the radial grid&#39;</span><span class="p">)</span>

            <span class="n">cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rref_m</span><span class="p">,</span> <span class="n">rad</span> <span class="o">*</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>

            <span class="n">Mhyd</span><span class="o">.</span><span class="n">cf_prof</span> <span class="o">=</span> <span class="n">cf</span>

    <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">psfmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">psfmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sum_mat</span><span class="p">)</span>

            <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat1</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">proj_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sum_mat</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

        <span class="n">Kdens_m</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rref_m</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">Kdens_m</span> <span class="o">=</span> <span class="n">calc_density_operator</span><span class="p">(</span><span class="n">rref_m</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">pardens</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">,</span> <span class="n">withbkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">hydro_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pnt</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">massmod</span> <span class="o">!=</span> <span class="s1">&#39;NFW&#39;</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Non-thermal pressure correction is currently implemented only for the NFW model, reverting to thermal only&#39;</span><span class="p">)</span>

            <span class="n">pnt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">file_means</span> <span class="o">=</span> <span class="n">get_data_file_path</span><span class="p">(</span><span class="s1">&#39;pnt_mean.dat&#39;</span><span class="p">)</span>

            <span class="n">file_cov</span> <span class="o">=</span> <span class="n">get_data_file_path</span><span class="p">(</span><span class="s1">&#39;pnt_covmat.dat&#39;</span><span class="p">)</span>

            <span class="n">pnt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_means</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1">#pnt_mean = np.array([[0.15288539, 1.07588625, 0.05624287]])</span>

            <span class="n">pnt_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file_cov</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1">#pnt_cov = np.array([[ 0.00400375, -0.0199079, -0.0022997 ], [-0.0199079, 0.54718882, 0.02912699],[-0.0022997, 0.02912699, 0.00343748]])</span>

    <span class="k">with</span> <span class="n">hydro_model</span><span class="p">:</span>
        <span class="c1"># Priors for unknown model parameters</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;coefs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">testval</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">npt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

            <span class="n">bkgd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;bkg&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">testbkg</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># in case fit_bkg = False this is not fitted</span>

            <span class="n">ctot</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">coefs</span><span class="p">,</span> <span class="n">bkgd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">al</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ctot</span><span class="p">)</span>

            <span class="n">pred</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">al</span><span class="p">)</span> <span class="o">+</span> <span class="n">bkgcounts</span>  <span class="c1"># Predicted number of counts per annulus</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">al</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>

            <span class="n">pred</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">al</span><span class="p">)</span>

        <span class="c1"># Model parameters</span>
        <span class="n">allpmod</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">fix</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>

                <span class="n">lim</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">modpar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">TruncatedNormal</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sd</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">sd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lower</span><span class="o">=</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">upper</span><span class="o">=</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">modpar</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">ConstantDist</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">allpmod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modpar</span><span class="p">)</span>

        <span class="n">pmod</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">allpmod</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Integration constant as a fitting (nuisance) parameter</span>
        <span class="k">if</span> <span class="n">p0_prior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">P0_est</span> <span class="o">=</span> <span class="n">p0_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">err_P0_est</span> <span class="o">=</span> <span class="n">p0_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">P0_est</span> <span class="o">=</span> <span class="n">estimate_P0</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">=</span><span class="n">Mhyd</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated value of P0: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P0_est</span><span class="p">))</span>

            <span class="n">err_P0_est</span> <span class="o">=</span> <span class="n">P0_est</span> <span class="c1"># 1 in ln</span>

        <span class="n">logp0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">TruncatedNormal</span><span class="p">(</span><span class="s1">&#39;logp0&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P0_est</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="n">err_P0_est</span> <span class="o">/</span> <span class="n">P0_est</span><span class="p">,</span>
                                   <span class="n">lower</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P0_est</span><span class="p">)</span> <span class="o">-</span> <span class="n">err_P0_est</span> <span class="o">/</span> <span class="n">P0_est</span><span class="p">,</span>
                                   <span class="n">upper</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P0_est</span><span class="p">)</span> <span class="o">+</span> <span class="n">err_P0_est</span> <span class="o">/</span> <span class="n">P0_est</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pnt</span><span class="p">:</span>

            <span class="n">pnt_pars</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MvNormal</span><span class="p">(</span><span class="s1">&#39;Pnt&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">pnt_mean</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">pnt_cov</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">RV</span> <span class="ow">in</span> <span class="n">hydro_model</span><span class="o">.</span><span class="n">basic_RVs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">RV</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">RV</span><span class="o">.</span><span class="n">logp</span><span class="p">(</span><span class="n">hydro_model</span><span class="o">.</span><span class="n">test_point</span><span class="p">))</span>

        <span class="n">press00</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logp0</span><span class="p">)</span>

        <span class="n">dens_m</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kdens_m</span><span class="p">,</span> <span class="n">al</span><span class="p">)</span> <span class="o">/</span> <span class="n">cf</span> <span class="o">*</span> <span class="n">transf</span><span class="p">)</span>  <span class="c1"># electron density in cm-3</span>

        <span class="c1"># Evaluate mass model</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">mfact</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">func_pm</span><span class="p">(</span><span class="n">rref_m</span><span class="p">,</span> <span class="o">*</span><span class="n">pmod</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">mfact0</span>

        <span class="k">if</span> <span class="n">dmonly</span><span class="p">:</span>

            <span class="n">nhconv</span> <span class="o">=</span> <span class="n">cgsamu</span> <span class="o">*</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">mu_e</span> <span class="o">*</span> <span class="n">cgskpc</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">Msun</span>  <span class="c1"># Msun/kpc^3</span>

            <span class="n">mgas</span> <span class="o">=</span> <span class="n">mgas_pm</span><span class="p">(</span><span class="n">rin_m</span><span class="p">,</span> <span class="n">rout_m</span><span class="p">,</span> <span class="n">dens_m</span><span class="p">)</span> <span class="o">*</span> <span class="n">nhconv</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">mfact0</span>

            <span class="c1"># Add stellar mass if provided</span>
            <span class="k">if</span> <span class="n">mstar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">mbar</span> <span class="o">=</span> <span class="n">mgas</span> <span class="o">+</span> <span class="n">mstar_m</span> <span class="o">/</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">mfact0</span> <span class="o">/</span> <span class="mf">1e13</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">mbar</span> <span class="o">=</span> <span class="n">mgas</span>

            <span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">+</span> <span class="n">mbar</span>

        <span class="c1"># Pressure gradient</span>
        <span class="n">dpres</span> <span class="o">=</span> <span class="o">-</span> <span class="n">mass</span> <span class="o">/</span> <span class="n">rref_m</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dens_m</span> <span class="o">*</span> <span class="p">(</span><span class="n">rout_m</span> <span class="o">-</span> <span class="n">rin_m</span><span class="p">)</span>

        <span class="n">press_out</span> <span class="o">=</span> <span class="n">press00</span> <span class="o">-</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">int_mat</span><span class="p">,</span> <span class="n">dpres</span><span class="p">)</span>  <span class="c1"># directly returns press_out</span>

        <span class="c1"># Non-thermal pressure correction, if any</span>
        <span class="k">if</span> <span class="n">pnt</span><span class="p">:</span>

            <span class="n">c200</span> <span class="o">=</span> <span class="n">pmod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">r200c</span> <span class="o">=</span> <span class="n">pmod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">alpha_turb</span> <span class="o">=</span> <span class="n">alpha_turb_pm</span><span class="p">(</span><span class="n">rref_m</span><span class="p">,</span> <span class="n">r200c</span><span class="p">,</span> <span class="n">c200</span><span class="p">,</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span> <span class="n">pnt_pars</span><span class="p">)</span>

            <span class="n">pth</span> <span class="o">=</span> <span class="n">press_out</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alpha_turb</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">pth</span> <span class="o">=</span> <span class="n">press_out</span>

        <span class="c1"># Density Likelihood</span>
        <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

            <span class="n">count_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">counts</span><span class="p">)</span> <span class="c1">#counts likelihood</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">sb_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;sb&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">sb</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">esb</span><span class="p">)</span> <span class="c1">#Sx likelihood</span>

        <span class="c1"># Temperature model and likelihood</span>
        <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Model temperature</span>
            <span class="n">t3d</span> <span class="o">=</span> <span class="n">pth</span> <span class="o">/</span> <span class="n">dens_m</span>

            <span class="c1"># Mazzotta weights</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="n">dens_m</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">t3d</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.75</span><span class="p">)</span>

            <span class="c1"># Temperature projection</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">proj_mat</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>

            <span class="n">tproj</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">proj_mat</span><span class="p">,</span> <span class="n">t3d</span> <span class="o">*</span> <span class="n">ei</span><span class="p">)</span> <span class="o">/</span> <span class="n">flux</span>

            <span class="n">T_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;kt&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">tproj</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">temp_x</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">errt_x</span><span class="p">)</span>  <span class="c1"># temperature likelihood</span>

        <span class="c1"># SZ pressure model and likelihood</span>
        <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">pfit</span> <span class="o">=</span> <span class="n">pth</span><span class="p">[</span><span class="n">index_sz</span><span class="p">]</span>

            <span class="n">P_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">MvNormal</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">pfit</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span><span class="o">.</span><span class="n">pres_sz</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span><span class="o">.</span><span class="n">covmat_sz</span><span class="p">)</span>  <span class="c1"># SZ pressure likelihood</span>


    <span class="n">tinit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running HMC...&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">hydro_model</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">find_map</span><span class="p">:</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nmcmc</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;ADVI&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nmcmc</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;ADVI&#39;</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


        <span class="n">Mhyd</span><span class="o">.</span><span class="n">ppc_sb</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sb&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">Mhyd</span><span class="o">.</span><span class="n">ppc_kt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;kt&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">Mhyd</span><span class="o">.</span><span class="n">ppc_sz</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Total computing time is: &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tend</span> <span class="o">-</span> <span class="n">tinit</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">,</span> <span class="s1">&#39; minutes&#39;</span><span class="p">)</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">hydro_model</span> <span class="o">=</span> <span class="n">hydro_model</span>

    <span class="c1"># Get chains and save them to file</span>
    <span class="n">chain_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;coefs&#39;</span><span class="p">])</span>

    <span class="n">sc_coefs</span> <span class="o">=</span> <span class="n">chain_coefs</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">sampc</span> <span class="o">=</span> <span class="n">chain_coefs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sc_coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sc_coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sc_coefs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>

        <span class="n">sampb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;bkg&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampc</span><span class="p">,</span> <span class="n">sampb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">sampc</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>

    <span class="k">if</span> <span class="n">samplefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">samplefile</span><span class="o">+</span><span class="s1">&#39;.par&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">nbetas</span><span class="p">,</span><span class="n">nbetas</span><span class="p">,</span><span class="n">min_beta</span><span class="p">,</span><span class="n">nmcmc</span><span class="p">]),</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;pymc3&#39;</span><span class="p">)</span>

    <span class="c1"># Compute output deconvolved brightness profile</span>

    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>
        <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">)</span>

        <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="n">bfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="n">npt</span><span class="p">]))</span>

        <span class="n">Mhyd</span><span class="o">.</span><span class="n">bkg</span> <span class="o">=</span> <span class="n">bfit</span>

        <span class="n">allsb_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">prof</span><span class="o">.</span><span class="n">psfmat</span><span class="p">,</span> <span class="n">allsb</span><span class="p">[:,</span> <span class="p">:</span><span class="n">npt</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Ksb</span> <span class="o">=</span> <span class="n">calc_sb_operator</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">sourcereg</span><span class="p">,</span> <span class="n">pars</span><span class="p">,</span> <span class="n">withbkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">allsb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ksb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="n">allsb_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb_dec</span> <span class="o">=</span> <span class="n">pmc</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb_dec_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb_dec_hi</span> <span class="o">=</span> <span class="n">pmch</span>

    <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allsb_conv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb_conv</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">allsb_conv</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb</span> <span class="o">=</span> <span class="n">pmc</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">sb_hi</span> <span class="o">=</span> <span class="n">pmch</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">nrc</span> <span class="o">=</span> <span class="n">nrc</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">nbetas</span> <span class="o">=</span> <span class="n">nbetas</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">min_beta</span> <span class="o">=</span> <span class="n">min_beta</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">nmore</span> <span class="o">=</span> <span class="n">nmore</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">pardens</span> <span class="o">=</span> <span class="n">pardens</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">fit_bkg</span> <span class="o">=</span> <span class="n">fit_bkg</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">dmonly</span> <span class="o">=</span> <span class="n">dmonly</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">mstar</span> <span class="o">=</span> <span class="n">mstar</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">pnt</span> <span class="o">=</span> <span class="n">pnt</span>
    <span class="k">if</span> <span class="n">pnt</span><span class="p">:</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">pnt_pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;Pnt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sc_coefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sc_coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">alldens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Kdens</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> <span class="o">*</span> <span class="n">transf</span><span class="p">)</span>
    <span class="n">pmc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>
    <span class="n">pmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">-</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>
    <span class="n">pmch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">alldens</span><span class="p">,</span> <span class="mf">50.</span> <span class="o">+</span> <span class="mf">68.3</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">ccf</span><span class="p">)</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="n">pmc</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">dens_lo</span> <span class="o">=</span> <span class="n">pmcl</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">dens_hi</span> <span class="o">=</span> <span class="n">pmch</span>

    <span class="n">samppar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">parnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">samppar</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">samplogp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s1">&#39;logp0&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">samppar</span> <span class="o">=</span> <span class="n">samppar</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">samplogp0</span> <span class="o">=</span> <span class="n">samplogp0</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">Kdens</span> <span class="o">=</span> <span class="n">Kdens</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">Ksb</span> <span class="o">=</span> <span class="n">Ksb</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">transf</span> <span class="o">=</span> <span class="n">transf</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">Kdens_m</span> <span class="o">=</span> <span class="n">Kdens_m</span>

    <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kt_mod</span> <span class="o">=</span> <span class="n">kt_from_samples</span><span class="p">(</span><span class="n">Mhyd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">)</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">ktmod</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;TSPEC&#39;</span><span class="p">]</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">ktmod_lo</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;TSPEC_LO&#39;</span><span class="p">]</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">ktmod_hi</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;TSPEC_HI&#39;</span><span class="p">]</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">kt3d</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;T3D&#39;</span><span class="p">]</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">kt3d_lo</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;T3D_LO&#39;</span><span class="p">]</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">kt3d_hi</span> <span class="o">=</span> <span class="n">kt_mod</span><span class="p">[</span><span class="s1">&#39;T3D_HI&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pmed</span><span class="p">,</span> <span class="n">plo</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">P_from_samples</span><span class="p">(</span><span class="n">Mhyd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">)</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">pmod</span> <span class="o">=</span> <span class="n">pmed</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">pmod_lo</span> <span class="o">=</span> <span class="n">plo</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">pmod_hi</span> <span class="o">=</span> <span class="n">phi</span>

    <span class="n">totlike</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">nptot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">npar</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">thermolike</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">npthermo</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">npar</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">if</span> <span class="n">fit_bkg</span><span class="p">:</span>
        <span class="n">totlike</span> <span class="o">=</span> <span class="n">totlike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;counts&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">nptot</span> <span class="o">=</span> <span class="n">nptot</span> <span class="o">+</span> <span class="n">npt</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1">#Mhyd.trace.log_likelihood[&#39;tot&#39;] = Mhyd.trace.log_likelihood[&#39;counts&#39;]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">totlike</span> <span class="o">=</span> <span class="n">totlike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;sb&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">nptot</span> <span class="o">=</span> <span class="n">nptot</span> <span class="o">+</span> <span class="n">npt</span>
        <span class="c1">#Mhyd.trace.log_likelihood[&#39;tot&#39;] = Mhyd.trace.log_likelihood[&#39;sb&#39;]</span>

    <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">totlike</span> <span class="o">=</span> <span class="n">totlike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;kt&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">thermolike</span> <span class="o">=</span> <span class="n">thermolike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;kt&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;kt&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">sz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">totlike</span> <span class="o">=</span> <span class="n">totlike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;P&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">thermolike</span> <span class="o">=</span> <span class="n">thermolike</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;log_likelihood&#39;</span><span class="p">][</span><span class="s1">&#39;P&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;tot&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">log_likelihood</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pnt</span><span class="p">:</span>
        <span class="n">nptot</span> <span class="o">=</span> <span class="n">nptot</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">npthermo</span> <span class="o">=</span> <span class="n">npthermo</span> <span class="o">+</span> <span class="mi">3</span>

    <span class="n">Mhyd</span><span class="o">.</span><span class="n">totlike</span> <span class="o">=</span> <span class="n">totlike</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">nptot</span> <span class="o">=</span> <span class="n">nptot</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">thermolike</span> <span class="o">=</span> <span class="n">thermolike</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">npthermo</span> <span class="o">=</span> <span class="n">npthermo</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">waic</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;tot&#39;</span><span class="p">)</span>
    <span class="n">Mhyd</span><span class="o">.</span><span class="n">loo</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">Mhyd</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;tot&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mhyd"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd">[docs]</a><span class="k">class</span> <span class="nc">Mhyd</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    The Mhyd class is the core class of hydromass. It allows the user to pass one or more datasets to be fitted, chose the mass reconstruction method, set options like change cosmology, Solar abundance table, NUTS options, model choice, and more.</span>

<span class="sd">    :param sbprofile: A pyproffit Profile object (https://pyproffit.readthedocs.io/en/latest/pyproffit.html#module-pyproffit.profextract) including the surface brightness data</span>
<span class="sd">    :type sbprofile: class:`pyproffit.profextract.Profile`</span>
<span class="sd">    :param spec_data: A :class:`hydromass.tpdata.SpecData` object including a spectroscopic X-ray temperature profile and its associated uncertainties</span>
<span class="sd">    :type spec_data: class:`hydromass.tpdata.SpecData`</span>
<span class="sd">    :param sz_data: A :class:`hydromass.tpdata.SZData` object containing an SZ pressure profile and its covariance matrix</span>
<span class="sd">    :type sz_data: class:`hydromass.tpdata.SZData`</span>
<span class="sd">    :param directory: Name of output file directory. Defaults to &#39;mhyd&#39;</span>
<span class="sd">    :type directory: str</span>
<span class="sd">    :param redshift: Source redshift</span>
<span class="sd">    :type redshift: float</span>
<span class="sd">    :param cosmo: Astropy cosmological model</span>
<span class="sd">    :type cosmo: class:`astropy.cosmology`</span>
<span class="sd">    :param f_abund: Solar abundance table. Available are &#39;angr&#39;, &#39;aspl&#39;, and &#39;grsa&#39;. Defaults to &#39;angr&#39;</span>
<span class="sd">    :type f_abund: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbprofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sz_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redshift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_abund</span> <span class="o">=</span> <span class="s1">&#39;angr&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;angr&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8337</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.6125</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1738</span>
        <span class="k">elif</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;aspl&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8527</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.5994</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1548</span>
        <span class="k">elif</span> <span class="n">f_abund</span> <span class="o">==</span> <span class="s1">&#39;grsa&#39;</span><span class="p">:</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8520</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.6000</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1555</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># aspl default</span>
            <span class="n">nhc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.8527</span>
            <span class="n">mup</span> <span class="o">=</span> <span class="mf">0.5994</span>
            <span class="n">mu_e</span> <span class="o">=</span> <span class="mf">1.1548</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nhc</span><span class="o">=</span><span class="n">nhc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mup</span><span class="o">=</span><span class="n">mup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_e</span><span class="o">=</span><span class="n">mu_e</span>

        <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output directory name provided, will output to subdirectory &quot;mhyd&quot; &#39;</span><span class="p">)</span>

            <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;mhyd&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">directory</span>

        <span class="k">if</span> <span class="n">sbprofile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no surface brightness profile provided, please provide one with the &quot;sbprofile=&quot; option&#39;</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sbprof</span> <span class="o">=</span> <span class="n">sbprofile</span>

        <span class="k">if</span> <span class="n">redshift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no redshift provided, please provide one with the &quot;redshift=&quot; option&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="n">redshift</span>

        <span class="k">if</span> <span class="n">cosmo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No cosmology provided, will default to Planck15&#39;</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">Planck15</span> <span class="k">as</span> <span class="n">cosmo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">cosmo</span>

        <span class="n">dlum</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">luminosity_distance</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dlum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dlum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Luminosity distance to the source: </span><span class="si">%g</span><span class="s1"> Mpc&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dlum</span><span class="p">))</span>

        <span class="n">amin2kpc</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">amin2kpc</span> <span class="o">=</span> <span class="n">amin2kpc</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;At the redshift of the source 1 arcmin is </span><span class="si">%g</span><span class="s1"> kpc&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amin2kpc</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">spec_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sz_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no spectral data file or SZ data file provided, please provide at least one with the &quot;spec_data=&quot; or &quot;sz_data=&quot; options&#39;</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="n">spec_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sz_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no spectral data file or SZ data file provided, please provide at least one with the &quot;spec_data=&quot; or &quot;sz_data=&quot; options&#39;</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="n">spec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">spec_data</span> <span class="o">=</span> <span class="n">spec_data</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">spec_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sz_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sz_data</span> <span class="o">=</span> <span class="n">sz_data</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sz_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">rho_cz</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">critical_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">cgsMpc</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">Msun</span> <span class="c1"># critical density in Msun per Mpc^3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mfact</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rho_cz</span> <span class="o">*</span> <span class="mf">1e-22</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mfact0</span> <span class="o">=</span> <span class="n">kev2erg</span> <span class="o">*</span> <span class="n">cgskpc</span> <span class="o">/</span> <span class="p">(</span><span class="n">cgsG</span> <span class="o">*</span> <span class="n">cgsamu</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mup</span><span class="p">)</span> <span class="o">/</span> <span class="n">Msun</span> <span class="o">/</span> <span class="mf">1e13</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mgas_fact</span> <span class="o">=</span> <span class="n">cgsamu</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_e</span> <span class="o">/</span> <span class="n">Msun</span>


<div class="viewcode-block" id="Mhyd.emissivity"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.emissivity">[docs]</a>    <span class="k">def</span> <span class="nf">emissivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nh</span><span class="p">,</span> <span class="n">rmf</span><span class="p">,</span> <span class="n">kt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">abund</span><span class="o">=</span><span class="s1">&#39;angr&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">elow</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ehigh</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">arf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the conversion between count rate and emissivity using XSPEC by run the :func:`hydromass.emissivity.calc_emissivity` function. Requires XSPEC to be available in PATH.</span>

<span class="sd">        :param nh: Source NH in units of 1e22 cm**(-2)</span>
<span class="sd">        :type nh: float</span>
<span class="sd">        :param kt: Source temperature in keV</span>
<span class="sd">        :type kt: float</span>
<span class="sd">        :param rmf: Path to response file (RMF/RSP)</span>
<span class="sd">        :type rmf: str</span>
<span class="sd">        :param abund: Solar abundance table in XSPEC format. Defaults to &quot;angr&quot;</span>
<span class="sd">        :type abund: str</span>
<span class="sd">        :param Z: Metallicity with respect to solar. Defaults to 0.3</span>
<span class="sd">        :type Z: float</span>
<span class="sd">        :param elow: Low-energy bound of the input image in keV. Defaults to 0.5</span>
<span class="sd">        :type elow: float</span>
<span class="sd">        :param ehigh: High-energy bound of the input image in keV. Defaults to 2.0</span>
<span class="sd">        :type ehigh: float</span>
<span class="sd">        :param arf: Path to on-axis ARF (optional, in case response file is RMF)</span>
<span class="sd">        :type arf: str</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">kt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">temp_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">kt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">temp_x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_data</span><span class="o">.</span><span class="n">errt_x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: no temperature provided, cannot proceed&#39;</span><span class="p">)</span>

                <span class="k">return</span>


        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean cluster temperature:&#39;</span><span class="p">,</span><span class="n">kt</span><span class="p">,</span><span class="s1">&#39; keV&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ccf</span> <span class="o">=</span> <span class="n">calc_emissivity</span><span class="p">(</span><span class="n">cosmo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo</span><span class="p">,</span>
                                        <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">,</span>
                                        <span class="n">nh</span><span class="o">=</span><span class="n">nh</span><span class="p">,</span>
                                        <span class="n">kt</span><span class="o">=</span><span class="n">kt</span><span class="p">,</span>
                                        <span class="n">rmf</span><span class="o">=</span><span class="n">rmf</span><span class="p">,</span>
                                        <span class="n">abund</span><span class="o">=</span><span class="n">abund</span><span class="p">,</span>
                                        <span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
                                        <span class="n">elow</span><span class="o">=</span><span class="n">elow</span><span class="p">,</span>
                                        <span class="n">ehigh</span><span class="o">=</span><span class="n">ehigh</span><span class="p">,</span>
                                        <span class="n">arf</span><span class="o">=</span><span class="n">arf</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mhyd.run"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">p0_prior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dmonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mstar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">find_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pnt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        :param model:  A :class:`hydromass.functions.Model` object including the chosen mass model and its input values (mandatory input)</span>
<span class="sd">        :type model: class:`hydromass.functions.Model`</span>
<span class="sd">        :param bkglim: Limit (in arcmin) out to which the SB data will be fitted; if None then the whole range is considered. Defaults to None.</span>
<span class="sd">        :type bkglim: float</span>
<span class="sd">        :param nmcmc: Number of PyMC3 steps. Defaults to 1000</span>
<span class="sd">        :type nmcmc: int</span>
<span class="sd">        :param fit_bkg: Choose whether the counts and the background will be fitted on-the-fly using a Poisson model (fit_bkg=True) or if the surface brightness will be fitted, in which case it is assumed that the background has already been subtracted and Gaussian likelihood will be used (default = False)</span>
<span class="sd">        :type fit_bkg: bool</span>
<span class="sd">        :param back: Input value for the background. If None then the mean surface brightness in the region outside &quot;bkglim&quot; is used. Relevant only if fit_bkg = True. Defaults to None.</span>
<span class="sd">        :type back: float</span>
<span class="sd">        :param samplefile: Name of ASCII file to output the final PyMC3 samples</span>
<span class="sd">        :type samplefile: str</span>
<span class="sd">        :param nrc: Number of core radii values to set up the multiscale model. Defaults to the number of data points / 4</span>
<span class="sd">        :type nrc: int</span>
<span class="sd">        :param nbetas: Number of beta values to set up the multiscale model (default = 6)</span>
<span class="sd">        :type nbetas: int</span>
<span class="sd">        :param min_beta: Minimum beta value (default = 0.6)</span>
<span class="sd">        :type min_beta: float</span>
<span class="sd">        :param nmore: Number of points to the define the fine grid onto which the mass model and the integration are performed, i.e. for one spectroscopic/SZ value, how many grid points will be defined. Defaults to 5.</span>
<span class="sd">        :type nmore: int</span>
<span class="sd">        :param p0_prior: Set of two values defining the mean and standard deviation of the Gaussian prior on p0. If None, the code attempts to determine the value of P0 using the :func:`hydromass.plots.estimate_P0` function, which fits a rough gNFW function to estimate the shape of the pressure profile and uses the fitted function to approximate the value of P0.</span>
<span class="sd">        :type p0_prior: numpy.ndarray</span>
<span class="sd">        :param tune: Number of NUTS tuning steps. Defaults to 500</span>
<span class="sd">        :type tune: int</span>
<span class="sd">        :param dmonly: Specify whether the mass model is fitted to the total mass (dmonly=False) or to the dark matter only after subtracting the gas mass and the stellar mass if provided (dmonly=True). Defaults to False.</span>
<span class="sd">        :type dmonly: bool</span>
<span class="sd">        :param mstar: If dmonly=True, provide an array containing the cumulative stellar mass profile, which will be subtracted when adjusting the mass model to the dark matter only.</span>
<span class="sd">        :type mstar: numpy.ndarray</span>
<span class="sd">        :param find_map: Specify whether a maximum likelihood fit will be performed first to initiate the sampler. Defaults to True</span>
<span class="sd">        :type find_map: bool</span>
<span class="sd">        :param pnt: Attempt to model the non-thermal pressure profile. If pnt=True, the non-thermal pressure profile of Angelinelli et al. 2020 and the corresponding parameters are used to marginalize over the impact of non-thermal pressure. Defaults to False.</span>
<span class="sd">        :type pnt: bool</span>
<span class="sd">        :param rmin: Minimum limiting radius (in arcmin) of the active region for the surface brightness. If rmin=None, no minimum radius is applied. Defaults to None.</span>
<span class="sd">        :type rmin: float</span>
<span class="sd">        :param rmax: Maximum limiting radius (in arcmin) of the active region for the surface brightness. If rmax=None, no maximum radius is applied. Defaults to None.</span>
<span class="sd">        :type rmax: float</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: No mass model provided&#39;</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="n">Run_Mhyd_PyMC3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span>
                       <span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span>
                       <span class="n">fit_bkg</span><span class="o">=</span><span class="n">fit_bkg</span><span class="p">,</span>
                       <span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span>
                       <span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span>
                       <span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span>
                       <span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span>
                       <span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">,</span>
                       <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">,</span>
                       <span class="n">p0_prior</span><span class="o">=</span><span class="n">p0_prior</span><span class="p">,</span>
                       <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
                       <span class="n">dmonly</span><span class="o">=</span><span class="n">dmonly</span><span class="p">,</span>
                       <span class="n">mstar</span><span class="o">=</span><span class="n">mstar</span><span class="p">,</span>
                       <span class="n">find_map</span><span class="o">=</span><span class="n">find_map</span><span class="p">,</span>
                       <span class="n">pnt</span><span class="o">=</span><span class="n">pnt</span><span class="p">,</span>
                       <span class="n">rmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span>
                       <span class="n">rmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mhyd.run_forward"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.run_forward">[docs]</a>    <span class="k">def</span> <span class="nf">run_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">find_map</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error no forward model provided&#39;</span><span class="p">)</span>

            <span class="k">return</span>


        <span class="n">Run_Forward_PyMC3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">Forward</span><span class="o">=</span><span class="n">forward</span><span class="p">,</span>
                          <span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span>
                          <span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span>
                          <span class="n">fit_bkg</span><span class="o">=</span><span class="n">fit_bkg</span><span class="p">,</span>
                          <span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span>
                          <span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span>
                          <span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span>
                          <span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span>
                          <span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">,</span>
                          <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">,</span>
                          <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
                          <span class="n">find_map</span><span class="o">=</span><span class="n">find_map</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mhyd.run_polytropic"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.run_polytropic">[docs]</a>    <span class="k">def</span> <span class="nf">run_polytropic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polytropic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">find_map</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">polytropic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error no polytropic model provided&#39;</span><span class="p">)</span>

            <span class="k">return</span>


        <span class="n">Run_Polytropic_PyMC3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">Polytropic</span><span class="o">=</span><span class="n">polytropic</span><span class="p">,</span>
                          <span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span>
                          <span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span>
                          <span class="n">fit_bkg</span><span class="o">=</span><span class="n">fit_bkg</span><span class="p">,</span>
                          <span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span>
                          <span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span>
                          <span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span>
                          <span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span>
                          <span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">,</span>
                          <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">,</span>
                          <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
                          <span class="n">find_map</span><span class="o">=</span><span class="n">find_map</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mhyd.run_GP"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.run_GP">[docs]</a>    <span class="k">def</span> <span class="nf">run_GP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkglim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmcmc</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">samplefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nrc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbetas</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_beta</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">nmore</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">find_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bin_fact</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">smin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngauss</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

        <span class="n">Run_NonParametric_PyMC3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">bkglim</span><span class="o">=</span><span class="n">bkglim</span><span class="p">,</span>
                                <span class="n">nmcmc</span><span class="o">=</span><span class="n">nmcmc</span><span class="p">,</span>
                                <span class="n">fit_bkg</span><span class="o">=</span><span class="n">fit_bkg</span><span class="p">,</span>
                                <span class="n">back</span><span class="o">=</span><span class="n">back</span><span class="p">,</span>
                                <span class="n">samplefile</span><span class="o">=</span><span class="n">samplefile</span><span class="p">,</span>
                                <span class="n">nrc</span><span class="o">=</span><span class="n">nrc</span><span class="p">,</span>
                                <span class="n">nbetas</span><span class="o">=</span><span class="n">nbetas</span><span class="p">,</span>
                                <span class="n">min_beta</span><span class="o">=</span><span class="n">min_beta</span><span class="p">,</span>
                                <span class="n">nmore</span><span class="o">=</span><span class="n">nmore</span><span class="p">,</span>
                                <span class="n">tune</span><span class="o">=</span><span class="n">tune</span><span class="p">,</span>
                                <span class="n">find_map</span><span class="o">=</span><span class="n">find_map</span><span class="p">,</span>
                                <span class="n">bin_fact</span><span class="o">=</span><span class="n">bin_fact</span><span class="p">,</span>
                                <span class="n">smin</span><span class="o">=</span><span class="n">smin</span><span class="p">,</span>
                                <span class="n">smax</span><span class="o">=</span><span class="n">smax</span><span class="p">,</span>
                                <span class="n">ngauss</span><span class="o">=</span><span class="n">ngauss</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mhyd.SaveModel"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.SaveModel">[docs]</a>    <span class="k">def</span> <span class="nf">SaveModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">SaveModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">model</span><span class="p">,</span>
                  <span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mhyd.SaveGP"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.SaveGP">[docs]</a>    <span class="k">def</span> <span class="nf">SaveGP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">SaveGP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="Mhyd.SaveForward"><a class="viewcode-back" href="../../hydromass.html#hydromass.mhyd.Mhyd.SaveForward">[docs]</a>    <span class="k">def</span> <span class="nf">SaveForward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Forward</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">SaveForward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">Forward</span><span class="p">,</span>
                    <span class="n">outfile</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, D. Eckert

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>